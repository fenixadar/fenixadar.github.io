<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>极简Prometheus监控实战 | FenixAdar&#39;s Blog</title><meta name="description" content="一、前言与目录监控是当前云原生时代下可观测性中关键性的一环，较之前相比，云原生时代已经发生了诸多变化，诸如微服务，容器化等技术层出不穷，且云原生时代的演进速度，更新速度极快，相对应监控所产生的数据量大大增加，对实时性的要求也大大增加。为应对变化，Prometheus应运而生，其所可实现的功能，与云原生极好的契合度，集成第三方开源组件的便利性，无疑使其成为无疑是最为耀眼的明星之一。 本文着重在于介绍"><meta property="og:type" content="article"><meta property="og:title" content="极简Prometheus监控实战"><meta property="og:url" content="https://fenixadar.github.io/2022/08/04/%E6%9E%81%E7%AE%80Prometheus%E7%9B%91%E6%8E%A7%E5%AE%9E%E6%88%98/index.html"><meta property="og:site_name" content="FenixAdar Blog"><meta property="og:description" content="一、前言与目录监控是当前云原生时代下可观测性中关键性的一环，较之前相比，云原生时代已经发生了诸多变化，诸如微服务，容器化等技术层出不穷，且云原生时代的演进速度，更新速度极快，相对应监控所产生的数据量大大增加，对实时性的要求也大大增加。为应对变化，Prometheus应运而生，其所可实现的功能，与云原生极好的契合度，集成第三方开源组件的便利性，无疑使其成为无疑是最为耀眼的明星之一。 本文着重在于介绍"><meta property="og:locale"><meta property="article:published_time" content="2022-08-04T02:47:39.000Z"><meta property="article:modified_time" content="2022-09-19T16:09:17.320Z"><meta property="article:author" content="FenixAdar"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://fenixadar.github.io/2022/08/04/%E6%9E%81%E7%AE%80Prometheus%E7%9B%91%E6%8E%A7%E5%AE%9E%E6%88%98/index.html"><link rel="alternate" href="/atom.xml" title="FenixAdar Blog" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 6.2.0"></head><body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/fenixadar" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">FenixAdar</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Xiamen, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="Search"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">Home</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">Archives</span></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">Board</h3><div class="widget-body"><div id="board"><div class="content"></div></div></div></div><div class="widget"><h3 class="widget-title">Archive</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a><span class="archive-list-count">2</span></li></ul></div></div><div class="widget"><h3 class="widget-title">Recent Posts</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2022/09/10/%E4%B8%AA%E4%BA%BA%E8%99%9A%E6%8B%9F%E5%8C%96%E5%AD%98%E7%AE%97%E5%88%86%E7%A6%BB%E6%94%B9%E9%80%A0/" class="title">个人虚拟化存算分离改造</a></p><p class="item-date"><time datetime="2022-09-10T03:06:41.000Z" itemprop="datePublished">2022-09-10</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2022/08/15/%E5%A8%81%E8%81%94%E9%80%9ANAS%20TS-873A%20%E5%AE%9E%E6%B5%8B/" class="title">威联通NAS TS-873A 实测</a></p><p class="item-date"><time datetime="2022-08-15T02:43:05.000Z" itemprop="datePublished">2022-08-15</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2022/08/04/%E6%9E%81%E7%AE%80Prometheus%E7%9B%91%E6%8E%A7%E5%AE%9E%E6%88%98/" class="title">极简Prometheus监控实战</a></p><p class="item-date"><time datetime="2022-08-04T02:47:39.000Z" itemprop="datePublished">2022-08-04</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2021/10/28/goframe%E4%B8%8Egin%E5%AF%B9%E6%AF%94(%E5%9B%9B)%20%E6%95%B0%E6%8D%AE%E8%BF%94%E5%9B%9E%E3%80%81Cookie%E3%80%81session%E3%80%81HTTPClient/" class="title">goframe与gin对比(四) 数据返回、Cookie、session、HTTPClient</a></p><p class="item-date"><time datetime="2021-10-28T10:51:05.000Z" itemprop="datePublished">2021-10-28</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2021/10/28/goframe%E4%B8%8Egin%E5%AF%B9%E6%AF%94(%E4%B8%89)%20%E8%AF%B7%E6%B1%82%E8%BE%93%E5%85%A5/" class="title">goframe与gin对比(三) 请求输入</a></p><p class="item-date"><time datetime="2021-10-28T10:50:36.000Z" itemprop="datePublished">2021-10-28</time></p></div></li></ul></div></div></div></aside><main class="main" role="main"><div class="content"><article id="post-极简Prometheus监控实战" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">极简Prometheus监控实战</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2022/08/04/%E6%9E%81%E7%AE%80Prometheus%E7%9B%91%E6%8E%A7%E5%AE%9E%E6%88%98/" class="article-date"><time datetime="2022-08-04T02:47:39.000Z" itemprop="datePublished">2022-08-04</time> </a></span><span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span> </span></span><span class="post-comment"><i class="icon icon-comment"></i> <a href="/2022/08/04/%E6%9E%81%E7%AE%80Prometheus%E7%9B%91%E6%8E%A7%E5%AE%9E%E6%88%98/#comments" class="article-comment-link">Comments</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">Word Count: 7.7k(words)</span> <span class="post-readcount hidden-xs" itemprop="timeRequired">Read Count: 38(minutes)</span></div></div><div class="article-entry marked-body" itemprop="articleBody"><h1 id="一、前言与目录"><a href="#一、前言与目录" class="headerlink" title="一、前言与目录"></a>一、前言与目录</h1><p>监控是当前云原生时代下可观测性中关键性的一环，较之前相比，云原生时代已经发生了诸多变化，诸如微服务，容器化等技术层出不穷，且云原生时代的演进速度，更新速度极快，相对应监控所产生的数据量大大增加，对实时性的要求也大大增加。为应对变化，Prometheus应运而生，其所可实现的功能，与云原生极好的契合度，集成第三方开源组件的便利性，无疑使其成为无疑是最为耀眼的明星之一。</p><p>本文着重在于介绍如何利用Prometheus搭建监控系统，涵盖探针，指标设定，可视化，告警设定，容器监控等。这是一篇入门级教程，暂不涵盖gateway，K8S集群等的相关内容。关于Prometheus的基本知识与概念，自行google之，本文重点描述实战过程。</p><p>目录：</p><ol><li>部署Prometheus Server</li><li>部署监控探针</li><li>部署Grafana</li><li>部署AlertManager</li><li>部署PrometheusAlert</li><li>配置告警规则</li></ol><h1 id="二、部署Prometheus-Server"><a href="#二、部署Prometheus-Server" class="headerlink" title="二、部署Prometheus Server"></a>二、部署Prometheus Server</h1><p>本节主要介绍以docker的方式部署Prometheus Server，并预留映射相关配置项</p><h2 id="2-1-配置环境"><a href="#2-1-配置环境" class="headerlink" title="2.1 配置环境"></a>2.1 配置环境</h2><ol><li>创建文件夹并授予权限<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -pv /data/docker/prometheus/&#123;data,alert_rules,job&#125;</span><br><span class="line">sudo chown -R myusername:myusername /data/docker/prometheus/</span><br></pre></td></tr></table></figure>其中,</li></ol><ul><li>data文件夹用于存放prometheus产生的数据</li><li>alert_rules文件夹用于存放prometheus alert告警规则配置文件</li><li>job用于存放监控对象配置json文件</li><li>myusername可替换为实际的用户名</li></ul><ol start="2"><li><p>执行本条命令以避免出现 permission denied 错误</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown 65534:65534 -R /data/docker/prometheus/data</span><br></pre></td></tr></table></figure></li><li><p>拷贝配置文件到指定的目录，注意下，需要关注该文件中涉及“$ip”的部分，后续配置，诸如添加AlertManager后，记得返回修改修改此处。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"># my global config</span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">  # scrape_timeout is set to the global default (10s).</span><br><span class="line"></span><br><span class="line"># Alertmanager configuration</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    # - targets: [&quot;$ip:9093&quot;]</span><br><span class="line">      # - alertmanager:9093</span><br><span class="line"></span><br><span class="line"># Load rules once and periodically evaluate them according to the global &#x27;evaluation_interval&#x27;.</span><br><span class="line">rule_files:</span><br><span class="line">  # - &quot;first_rules.yml&quot;</span><br><span class="line">  # - &quot;second_rules.yml&quot;</span><br><span class="line">  - /etc/prometheus/alert_rules/*.rules</span><br><span class="line"></span><br><span class="line"># A scrape configuration containing exactly one endpoint to scrape:</span><br><span class="line"># Here it&#x27;s Prometheus itself.</span><br><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &#x27;prometheus&#x27;</span><br><span class="line">    file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">      - /etc/prometheus/job/prometheus.json</span><br><span class="line">      refresh_interval: 1m  # 重载配置文件</span><br><span class="line"></span><br><span class="line">  # Node 主机组</span><br><span class="line">  - job_name: &#x27;host&#x27;</span><br><span class="line">    #basic_auth:</span><br><span class="line">    #  username: prometheus</span><br><span class="line">    #  password: prometheus</span><br><span class="line">    file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">      - /etc/prometheus/job/host.json</span><br><span class="line">      refresh_interval: 1m</span><br><span class="line"></span><br><span class="line">  # cadvisor 容器组</span><br><span class="line">  - job_name: &#x27;cadvisor&#x27;</span><br><span class="line">    file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">      - /etc/prometheus/job/cadvisor.json</span><br><span class="line">      refresh_interval: 1m</span><br><span class="line"></span><br><span class="line">  # mysql exporter 组</span><br><span class="line">  - job_name: &#x27;mysqld-exporter&#x27;</span><br><span class="line">    file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">      - /etc/prometheus/job/mysqld-exporter.json</span><br><span class="line">      refresh_interval: 1m</span><br><span class="line"></span><br><span class="line">  # blackbox ping 组</span><br><span class="line">  - job_name: &#x27;blackbox_ping&#x27;</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line">    scrape_timeout: 2s</span><br><span class="line">    metrics_path: /probe</span><br><span class="line">    params:</span><br><span class="line">      module: [ping]</span><br><span class="line">    file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">      - /etc/prometheus/job/blackbox/ping/*.json</span><br><span class="line">      refresh_interval: 1m</span><br><span class="line">    relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: $ip:9115</span><br><span class="line"></span><br><span class="line">  # blackbox http get 2xx 组</span><br><span class="line">  - job_name: &#x27;blackbox_http_2xx&#x27;</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line">    metrics_path: /probe</span><br><span class="line">    params:</span><br><span class="line">      module: [http_2xx]</span><br><span class="line">    file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">      - /etc/prometheus/job/blackbox/http_2xx/*.json</span><br><span class="line">      refresh_interval: 1m</span><br><span class="line">    relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: $ip:9115</span><br><span class="line"></span><br><span class="line">  - job_name: &quot;blackbox_tcp&quot;</span><br><span class="line">    metrics_path: /probe</span><br><span class="line">    params:</span><br><span class="line">      module: [tcp_connect]</span><br><span class="line">    file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">      - /etc/prometheus/job/blackbox/tcp/*.json</span><br><span class="line">      refresh_interval: 1m</span><br><span class="line">    relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: $ip:9115</span><br><span class="line"></span><br><span class="line">  - job_name: &#x27;blackbox_ssh_banner&#x27;</span><br><span class="line">    metrics_path: /probe</span><br><span class="line">    params:</span><br><span class="line">      module: [ssh_banner]</span><br><span class="line">    file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">      - /etc/prometheus/job/blackbox/ssh_banner/*.json</span><br><span class="line">      refresh_interval: 1m</span><br><span class="line">    relabel_configs:</span><br><span class="line">      # Ensure port is 22, pass as URL parameter</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        regex: (.*?)(:.*)?</span><br><span class="line">        replacement: $&#123;1&#125;:22</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      # Make instance label the target</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      # Actually talk to the blackbox exporter though</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: $ip:9115</span><br><span class="line"></span><br><span class="line">  - job_name: &quot;blackbox_dns&quot;</span><br><span class="line">    metrics_path: /probe</span><br><span class="line">    params:</span><br><span class="line">      module: [dns_udp]</span><br><span class="line">    file_sd_configs:</span><br><span class="line">    - files:</span><br><span class="line">      - /etc/prometheus/job/blackbox/dns/*.json</span><br><span class="line">      refresh_interval: 1m</span><br><span class="line">    relabel_configs:</span><br><span class="line">      - source_labels: [__address__]</span><br><span class="line">        target_label: __param_target</span><br><span class="line">      - source_labels: [__param_target]</span><br><span class="line">        target_label: instance</span><br><span class="line">      - target_label: __address__</span><br><span class="line">        replacement: $ip:9115</span><br></pre></td></tr></table></figure></li></ol><h2 id="2-2-启动服务端"><a href="#2-2-启动服务端" class="headerlink" title="2.2 启动服务端"></a>2.2 启动服务端</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd  \</span><br><span class="line">  -p 9090:9090 \</span><br><span class="line">  -v /data/docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro \</span><br><span class="line">  -v /data/docker/prometheus/alert_rules:/etc/prometheus/alert_rules \</span><br><span class="line">  -v /data/docker/prometheus/job:/etc/prometheus/job \</span><br><span class="line">  -v /data/docker/prometheus/data:/data/prometheus/ \</span><br><span class="line">  -v /etc/timezone:/etc/timezone:ro \</span><br><span class="line">  -v /etc/localtime:/etc/localtime:ro \</span><br><span class="line">  --name prometheus \</span><br><span class="line">  --restart=always \</span><br><span class="line">  prom/prometheus:v2.28.1 \</span><br><span class="line">  --config.file=/etc/prometheus/prometheus.yml  \</span><br><span class="line">  --storage.tsdb.path=/data/prometheus/ \</span><br><span class="line">  --storage.tsdb.retention.time=30d \</span><br><span class="line">  --web.read-timeout=5m \</span><br><span class="line">  --web.max-connections=10 \</span><br><span class="line">  --query.max-concurrency=20 \</span><br><span class="line">  --query.timeout=2m \</span><br><span class="line">  --web.enable-lifecycle</span><br></pre></td></tr></table></figure><p>启动成功后，通过浏览器访问 http:&#x2F;&#x2F;$ip:9090 可看到界面。</p><p>如果系统打开了防火墙，你可能需要给以下几个端口开白名单，以centos7为例，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --zone=public --add-port=9090/tcp --permanent</span><br><span class="line">sudo firewall-cmd --zone=public --add-port=9100/tcp --permanent</span><br><span class="line">sudo firewall-cmd --zone=public --add-port=3000/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure><h2 id="2-3-部署-Prometheus-Server-参考文档"><a href="#2-3-部署-Prometheus-Server-参考文档" class="headerlink" title="2.3 部署 Prometheus Server 参考文档"></a>2.3 部署 Prometheus Server 参考文档</h2><p><a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">https://prometheus.io/docs/prometheus/latest/configuration/configuration/</a></p><h1 id="三、部署监控探针"><a href="#三、部署监控探针" class="headerlink" title="三、部署监控探针"></a>三、部署监控探针</h1><p>Prometheus与Zabbix不同，Prometheus主要采用主动拉取的模式，通过Exporter提供的接口读取监控数据。Exporter负责采集数据，可以把Exporter理解为探针，并通过http的方式提供接口供Server调用读取数据，读者可自行google本文未描述的各个exporter提供的返回结果内字段的含义。</p><h2 id="3-1-部署node-exporter"><a href="#3-1-部署node-exporter" class="headerlink" title="3.1 部署node_exporter"></a>3.1 部署node_exporter</h2><p>node_exporter用于监控主机的CPU，内存，磁盘，I&#x2F;O等的信息。侧重点在于主机系统本身的数据采集。</p><ol><li>下载 node exporter 并解压</li></ol><p>登录需要被监控的主机，可从 <a target="_blank" rel="noopener" href="https://github.com/prometheus/node_exporter/tags">此处</a> 下载 node exporter</p><p>或者运行<code>curl -O https://github.com/prometheus/node_exporter/releases/download/v1.2.0/node_exporter-1.2.0.linux-amd64.tar.gz</code></p><p>下载完成后，运行以下命令解压二进制包</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar xvfz node_exporter-1.2.0.linux-amd64.tar.gz</span><br><span class="line">sudo mkdir -p /data/node_exporter/</span><br><span class="line">sudo mv node_exporter-1.2.0.linux-amd64/* /data/node_exporter/</span><br></pre></td></tr></table></figure><ol start="2"><li><p>创建prometheus用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo groupadd prometheus</span><br><span class="line">sudo useradd -g prometheus -m -d /var/lib/prometheus -s /sbin/nologin prometheus</span><br><span class="line">sudo chown prometheus.prometheus -R /data/node_exporter/</span><br></pre></td></tr></table></figure></li><li><p>创建Systemd服务</p></li></ol><p>添加并编辑文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/systemd/system/node_exporter.service</span><br></pre></td></tr></table></figure><p>写入以下内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=node_exporter</span><br><span class="line">Documentation=https://prometheus.io/</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/data/node_exporter/node_exporter</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><ol start="4"><li>使用systemctl 启动 node exporter<br>启动并查看服务是否正常<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start node_exporter</span><br><span class="line">sudo systemctl status node_exporter</span><br></pre></td></tr></table></figure></li></ol><p>应该返回类似以下的文本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">● node_exporter.service - node_exporter</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/node_exporter.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since 三 2019-06-05 09:18:56 GMT; 3s ago</span><br><span class="line"> Main PID: 11050 (node_exporter)</span><br><span class="line">   CGroup: /system.slice/node_exporter.service</span><br><span class="line">           └─11050 /usr/local/prometheus/node_exporter/node_exporter</span><br></pre></td></tr></table></figure><p>设置开机启动: <code>sudo systemctl enable node_exporter</code></p><ol start="5"><li>开启防火墙白名单<br>执行<code>curl localhost:9100</code>，如可以看到返回的网页，说明 node exporter 已经启动成功了。<br>在同网段内其他机器执行<code>curl http://$ip:9100/</code>，应同样可以看到返回的页面。</li></ol><p>如果看不到返回的页面，可以检查下是否为防火墙端口未开</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --zone=public --add-port=9100/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure><ol start="6"><li><p>配置 Prometheus<br>登录 Prometheus 服务端，编辑以下文件<br><code>nano /data/docker/prometheus/job/host.json</code>, 内容参考如下，ip地址自行更改实际的ip地址</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;targets&quot;: [ &quot;192.168.1.100:9100&quot;],</span><br><span class="line">    &quot;labels&quot;: &#123;</span><br><span class="line">      &quot;subject&quot;: &quot;node_exporter&quot;,</span><br><span class="line">      &quot;hostname&quot;: &quot;server1&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;targets&quot;: [ &quot;192.168.1.101:9100&quot;],</span><br><span class="line">    &quot;labels&quot;: &#123;</span><br><span class="line">      &quot;subject&quot;: &quot;node_exporter&quot;,</span><br><span class="line">      &quot;hostname&quot;: &quot;server2&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li><li><p>部署 node_exporter 可参考文档<br><a target="_blank" rel="noopener" href="https://github.com/prometheus/node_exporter">https://github.com/prometheus/node_exporter</a><br><a target="_blank" rel="noopener" href="https://prometheus.io/docs/guides/node-exporter/">https://prometheus.io/docs/guides/node-exporter/</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/7bec152d1a1f">https://www.jianshu.com/p/7bec152d1a1f</a></p></li></ol><h2 id="3-2-部署mysqld-exporter"><a href="#3-2-部署mysqld-exporter" class="headerlink" title="3.2 部署mysqld-exporter"></a>3.2 部署mysqld-exporter</h2><p>mysqld-exporter 用于监控MySQL数据库的性能等数据。</p><ol><li>登录mysql数据库所在主机，并通过docker方式启动<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  -p 9104:9104 \</span><br><span class="line">  --link mysql  \</span><br><span class="line">  --name mysqld-exporter \</span><br><span class="line">  --restart on-failure:5 \</span><br><span class="line">  -e DATA_SOURCE_NAME=&quot;root:pwdpwdpwdpwdpwd@(mysql:3306)/&quot; \</span><br><span class="line">  prom/mysqld-exporter:v0.13.0</span><br></pre></td></tr></table></figure></li></ol><p>启动后，访问<code>http://127.0.0.1:9104/metrics</code>，可看到监控信息，同时从Prometheus服务端访问也应要可访问的到。</p><ol start="2"><li>部署 mysqld-exporter 可参考文档<br><a target="_blank" rel="noopener" href="https://github.com/prometheus/mysqld_exporter">https://github.com/prometheus/mysqld_exporter</a><br><a target="_blank" rel="noopener" href="https://registry.hub.docker.com/r/prom/mysqld-exporter/">https://registry.hub.docker.com/r/prom/mysqld-exporter/</a></li></ol><h2 id="3-3-部署cadvisor"><a href="#3-3-部署cadvisor" class="headerlink" title="3.3 部署cadvisor"></a>3.3 部署cadvisor</h2><p>cadvisor用于监控容器的状态。</p><ol><li>登录docker所在主机并通过运行以下脚本启动cadvisor<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">  --volume=/:/rootfs:ro \</span><br><span class="line">  --volume=/var/run:/var/run:ro \</span><br><span class="line">  --volume=/sys:/sys:ro \</span><br><span class="line">  --volume=/var/lib/docker/:/var/lib/docker:ro \</span><br><span class="line">  --volume=/dev/disk/:/dev/disk:ro \</span><br><span class="line">  --publish=9101:8080 \</span><br><span class="line">  --detach=true \</span><br><span class="line">  --name=cadvisor \</span><br><span class="line">  --restart on-failure:5 \</span><br><span class="line">  --privileged \</span><br><span class="line">  --device=/dev/kmsg \</span><br><span class="line">  gcr.io/cadvisor/cadvisor:v0.38.6</span><br></pre></td></tr></table></figure></li></ol><p>你可能会找到两种 cadvisor，一种是 gcr.io&#x2F;cadvisor&#x2F;cadvisor, 另一种是 google&#x2F;cadvisor, 建议使用 gcr.io&#x2F;cadvisor&#x2F;cadvisor</p><ol start="2"><li><p>配置 Prometheus 服务端<br>登录Prometheus 服务端所在主机，编辑 <code>nano /data/docker/prometheus/job/cadvisor.json</code> 文件, 内容参考如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;targets&quot;: [ &quot;192.168.1.100:9101&quot;],</span><br><span class="line">    &quot;labels&quot;: &#123;</span><br><span class="line">      &quot;subject&quot;: &quot;cadvisor&quot;,</span><br><span class="line">      &quot;hostname&quot;: &quot;server1&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;targets&quot;: [ &quot;192.168.1.101:9101&quot;],</span><br><span class="line">    &quot;labels&quot;: &#123;</span><br><span class="line">      &quot;subject&quot;: &quot;cadvisor&quot;,</span><br><span class="line">      &quot;hostname&quot;: &quot;server2&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li><li><p>如果docker所在主机存在防火墙，记得添加防火墙白名单</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --zone=public --add-port=9101/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure></li><li><p>部署 cadvisor 可参考文档<br><a target="_blank" rel="noopener" href="https://github.com/google/cadvisor">https://github.com/google/cadvisor</a></p></li></ol><h2 id="3-4-部署blackbox-exporter"><a href="#3-4-部署blackbox-exporter" class="headerlink" title="3.4 部署blackbox_exporter"></a>3.4 部署blackbox_exporter</h2><p>blackbox_exporter 是以黑盒方式进行监控的工具</p><ol><li>创建配置文件<br>登录 Prometheus 服务端主机，执行以下命令<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /data/docker/blackbox/conf</span><br><span class="line">sudo chown -R myusername:myusername /data/docker/blackbox</span><br></pre></td></tr></table></figure></li></ol><p>并添加编辑该文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano /data/docker/blackbox/conf/blackbox.yml</span><br></pre></td></tr></table></figure><p>yml文件范本如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">modules:</span><br><span class="line">  ping:</span><br><span class="line">    prober: icmp</span><br><span class="line">    timeout: 5s</span><br><span class="line">    icmp:</span><br><span class="line">      preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="line">  http_2xx:</span><br><span class="line">    prober: http</span><br><span class="line">    timeout: 5s</span><br><span class="line">    http:</span><br><span class="line">      method: GET</span><br><span class="line">      preferred_ip_protocol: &quot;ip4&quot; # defaults to &quot;ip4&quot;</span><br><span class="line">      ip_protocol_fallback: false  # no fallback to &quot;ip6&quot;</span><br><span class="line">  http_post_2xx:</span><br><span class="line">    prober: http</span><br><span class="line">    timeout: 5s</span><br><span class="line">    http:</span><br><span class="line">      method: POST</span><br><span class="line">      preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="line">  http_post_2xx_json:</span><br><span class="line">    prober: http</span><br><span class="line">    timeout: 30s</span><br><span class="line">    http:</span><br><span class="line">      preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="line">      method: POST</span><br><span class="line">      headers:</span><br><span class="line">        Content-Type: application/json</span><br><span class="line">      body: &#x27;&#123;&quot;key1&quot;:&quot;&quot;vlaue1,&quot;params&quot;:&#123;&quot;param2&quot;:&quot;vlaue2&quot;&#125;&#125;&#x27;</span><br><span class="line">  http_basic_auth:</span><br><span class="line">    prober: http</span><br><span class="line">    timeout: 60s</span><br><span class="line">    http:</span><br><span class="line">      method: POST</span><br><span class="line">      headers:</span><br><span class="line">        Host: &quot;login.example.com&quot;</span><br><span class="line">      basic_auth:</span><br><span class="line">        username: &quot;username&quot;</span><br><span class="line">        password: &quot;mysecret&quot;</span><br><span class="line"></span><br><span class="line">  tls_connect:</span><br><span class="line">    prober: tcp</span><br><span class="line">    timeout: 5s</span><br><span class="line">    tcp:</span><br><span class="line">      tls: true</span><br><span class="line">  tcp_connect:</span><br><span class="line">    prober: tcp</span><br><span class="line">    timeout: 5s</span><br><span class="line"></span><br><span class="line">  pop3s_banner:</span><br><span class="line">    prober: tcp</span><br><span class="line">    tcp:</span><br><span class="line">      query_response:</span><br><span class="line">      - expect: &quot;^+OK&quot;</span><br><span class="line">      tls: true</span><br><span class="line"></span><br><span class="line">  ssh_banner:</span><br><span class="line">    prober: tcp</span><br><span class="line">    tcp:</span><br><span class="line">      query_response:</span><br><span class="line">      - expect: &quot;^SSH-2.0-&quot;</span><br><span class="line">      - send: SSH-2.0-blackbox-ssh-check</span><br><span class="line"></span><br><span class="line">  irc_banner:</span><br><span class="line">    prober: tcp</span><br><span class="line">    tcp:</span><br><span class="line">      query_response:</span><br><span class="line">      - send: &quot;NICK prober&quot;</span><br><span class="line">      - send: &quot;USER prober prober prober :prober&quot;</span><br><span class="line">      - expect: &quot;PING :([^ ]+)&quot;</span><br><span class="line">        send: &quot;PONG $&#123;1&#125;&quot;</span><br><span class="line">      - expect: &quot;^:[^ ]+ 001&quot;</span><br><span class="line"></span><br><span class="line">  dns_udp:</span><br><span class="line">    prober: dns</span><br><span class="line">    timeout: 10s</span><br><span class="line">    dns:</span><br><span class="line">      transport_protocol: udp</span><br><span class="line">      preferred_ip_protocol: ip4</span><br><span class="line">      query_name: &quot;www.example.cn&quot;</span><br><span class="line">      query_type: &quot;A&quot;</span><br></pre></td></tr></table></figure><ol start="2"><li>配置 Prometheus<br>继续在 Prometheus 服务端主机，执行以下命令<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /data/docker/prometheus/job/blackbox/</span><br><span class="line"></span><br><span class="line">sudo mkdir -pv /data/docker/prometheus/job/blackbox/&#123;dns,http_2xx,ping,ssh_banner,tcp&#125;</span><br><span class="line">sudo chown -R myusername:myusername /data/docker/prometheus/job/blackbox/</span><br></pre></td></tr></table></figure></li></ol><p>以下依次在<code>/data/docker/prometheus/job/blackbox/</code>下的对应的文件夹中，创建json文件，并参考样本写入配置</p><p>在dns文件夹下，创建 dns.json，样本如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;targets&quot;: [ &quot;192.168.1.1&quot;],</span><br><span class="line">    &quot;labels&quot;: &#123;</span><br><span class="line">      &quot;subject&quot;: &quot;blackbox_dns&quot;,</span><br><span class="line">      &quot;app&quot;: &quot;my_dns&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>在http_2xx文件夹下，创建 search-site.json，样本如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;targets&quot;: [ &quot;https://www.google.cn/?HealthCheck&quot;],</span><br><span class="line">    &quot;labels&quot;: &#123;</span><br><span class="line">      &quot;app&quot;: &quot;google&quot;,</span><br><span class="line">      &quot;subject&quot;: &quot;blackbox_http_2xx&quot;,</span><br><span class="line">      &quot;hostname&quot;: &quot;server-01&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;targets&quot;: [ &quot;https://cn.bing.com/?HealthCheck&quot;],</span><br><span class="line">    &quot;labels&quot;: &#123;</span><br><span class="line">      &quot;app&quot;: &quot;bing&quot;,</span><br><span class="line">      &quot;subject&quot;: &quot;blackbox_http_2xx&quot;,</span><br><span class="line">      &quot;hostname&quot;: &quot;server-02&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>在ping文件夹下，创建 search-site.json，样本如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;targets&quot;: [ &quot;www.google.cn&quot;],</span><br><span class="line">    &quot;labels&quot;: &#123;</span><br><span class="line">      &quot;app&quot;: &quot;google&quot;,</span><br><span class="line">      &quot;subject&quot;: &quot;blackbox_ping&quot;,</span><br><span class="line">      &quot;hostname&quot;: &quot;server-01&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;targets&quot;: [ &quot;cn.bing.com&quot;],</span><br><span class="line">    &quot;labels&quot;: &#123;</span><br><span class="line">      &quot;app&quot;: &quot;bing&quot;,</span><br><span class="line">      &quot;subject&quot;: &quot;blackbox_ping&quot;,</span><br><span class="line">      &quot;hostname&quot;: &quot;server-02&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>在ssh_banner文件夹下，创建 ssh-banner.json，样本如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;targets&quot;: [ &quot;192.168.1.100:22&quot;],</span><br><span class="line">    &quot;labels&quot;: &#123;</span><br><span class="line">      &quot;subject&quot;: &quot;blackbox_ssh_banner&quot;,</span><br><span class="line">      &quot;hostname&quot;: &quot;server-01&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;targets&quot;: [ &quot;192.168.1.101:22&quot;],</span><br><span class="line">    &quot;labels&quot;: &#123;</span><br><span class="line">      &quot;subject&quot;: &quot;blackbox_ssh_banner&quot;,</span><br><span class="line">      &quot;hostname&quot;: &quot;server-02&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>在tcp文件夹下，创建 tcp.json，样本如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;targets&quot;: [ &quot;$ip:3306&quot;],</span><br><span class="line">    &quot;labels&quot;: &#123;</span><br><span class="line">      &quot;app&quot;: &quot;mysql.example.cn&quot;,</span><br><span class="line">      &quot;subject&quot;: &quot;blackbox_tcp&quot;,</span><br><span class="line">      &quot;hostname&quot;: &quot;mysql&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ol start="3"><li>运行blackbox_exporter</li></ol><p>在 Prometheus服务端所在的主机，运行以下命令，使用容器启动blackbox_exporter</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --restart on-failure:5 \</span><br><span class="line">  -p 9115:9115 \</span><br><span class="line">  -v /data/docker/blackbox/conf/blackbox.yml:/config/blackbox.yml:ro \</span><br><span class="line">  --name blackbox_exporter \</span><br><span class="line">  prom/blackbox-exporter:v0.19.0 \</span><br><span class="line">  --config.file=/config/blackbox.yml</span><br></pre></td></tr></table></figure><p>启动成功后，访问<code>http://$ip:9090/targets</code>，可看到至今为止，我们配置的所有探针所反馈回来的数据，其中，State应为UP状态。</p><ol start="4"><li>部署 blackbox_exporter 可参考文档<br><a target="_blank" rel="noopener" href="https://github.com/prometheus/blackbox_exporter">https://github.com/prometheus/blackbox_exporter</a><br><a target="_blank" rel="noopener" href="https://yunlzheng.gitbook.io/prometheus-book/part-ii-prometheus-jin-jie/exporter/commonly-eporter-usage/install_blackbox_exporter">https://yunlzheng.gitbook.io/prometheus-book/part-ii-prometheus-jin-jie/exporter/commonly-eporter-usage/install_blackbox_exporter</a></li></ol><h1 id="四、部署Grafana"><a href="#四、部署Grafana" class="headerlink" title="四、部署Grafana"></a>四、部署Grafana</h1><p>接下来，部署可视化工具Grafana，Grafana可快速集成Prometheus，并通过设定甚至是使用现成的模板，快速将采集结果转变为图形化的页面。</p><h2 id="4-1-启动"><a href="#4-1-启动" class="headerlink" title="4.1 启动"></a>4.1 启动</h2><p>运行以下命令，做启动前的准备工作</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /data/docker/grafana</span><br><span class="line">sudo chown 472:472 /data/docker/grafana -R</span><br></pre></td></tr></table></figure><p>通过docker运行grafana</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  -p 3000:3000 \</span><br><span class="line">  --name=grafana \</span><br><span class="line">  -v /data/docker/grafana:/var/lib/grafana \</span><br><span class="line">  -v /etc/localtime:/etc/localtime:ro \</span><br><span class="line">  --restart=always \</span><br><span class="line">  --name grafana \</span><br><span class="line">  grafana/grafana:8.0.6</span><br></pre></td></tr></table></figure><p>启动成功后，可通过<code>http://$ip:3000</code>访问页面，默认账号密码: admin &#x2F; admin 。</p><h2 id="4-2-配置"><a href="#4-2-配置" class="headerlink" title="4.2 配置"></a>4.2 配置</h2><ol><li><p>配置数据源<br>点击“Configuration -&gt; Data sources”，进入 <code>http://$ip:3000/datasources</code>，增加Prometheus数据源，并做好配置。</p></li><li><p>配置Dashboards</p></li></ol><p>点击“Dashboards -&gt; Manage -&gt; import”，进入<code>http://$ip:3000/dashboard/import</code>，导入 Grafana Dashboards 模板，在<code>Import via grafana.com</code>处，填入你想要导入的模板id，常用的模板id如下：</p><ul><li>node exporter ID: 8919</li><li>Cadvisor ID: 14282</li><li>mysqld-exporter ID: 7362</li></ul><p>你也可以在<code>https://grafana.com/grafana/dashboards</code>，自行搜索 Dashboards 模板。也可以自行创建dashboard面板。</p><h2 id="4-3-部署-Grafana-可参考文档"><a href="#4-3-部署-Grafana-可参考文档" class="headerlink" title="4.3 部署 Grafana 可参考文档"></a>4.3 部署 Grafana 可参考文档</h2><p><a target="_blank" rel="noopener" href="https://grafana.com/docs/grafana/latest/installation/docker/">https://grafana.com/docs/grafana/latest/installation/docker/</a></p><h1 id="五、部署AlertManager"><a href="#五、部署AlertManager" class="headerlink" title="五、部署AlertManager"></a>五、部署AlertManager</h1><p>截至到现在，我们已经部署好Prometheus Server，Exporter，Grafana可视化组件，我们还需要配置告警组件，当故障出现时，监控系统可通过多种方式告知接收人，以便接收人及时知晓并处理。但Prometheus本身并不自带告警工具，Prometheus可以通过预配置的规则，将信息发送到AlertManager，由AlertManager统一处理告警信息，并通过邮箱，短信，微信，钉钉等方式告知告警接收人。和Grafana一样，AlertManager同样不仅仅支持Prometheus，也支持集成处理其他程序的信息。</p><h2 id="5-1-准备工作"><a href="#5-1-准备工作" class="headerlink" title="5.1 准备工作"></a>5.1 准备工作</h2><p>运行以下命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -pv /data/docker/alertmanager</span><br><span class="line">sudo chown -R myusername:myusername /data/docker/alertmanager/</span><br><span class="line">cd /data/docker/alertmanager</span><br></pre></td></tr></table></figure><p>在<code>/data/docker/alertmanager</code>文件夹中，创建alertmanager.yml 和 email.tmpl 文件，</p><p>alertmanager.yml的样例如下，注意要设置smtp相关配置项与webhook的ddurl：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  resolve_timeout: 5m</span><br><span class="line">  # 邮件SMTP配置</span><br><span class="line">  smtp_smarthost: &#x27;smtp.gmail.com:465&#x27;</span><br><span class="line">  smtp_from: &#x27;example@gmail.com&#x27;</span><br><span class="line">  smtp_auth_username: &#x27;example@gmail.com&#x27;</span><br><span class="line">  smtp_auth_password: &#x27;xxxxx&#x27;</span><br><span class="line">  smtp_require_tls: false</span><br><span class="line"># 自定义通知模板</span><br><span class="line">templates:</span><br><span class="line">  - &#x27;/etc/alertmanager/email.tmpl&#x27;</span><br><span class="line"># route用来设置报警的分发策略</span><br><span class="line">route:</span><br><span class="line">  # 采用哪个标签来作为分组依据</span><br><span class="line">  group_by: [&#x27;alertname&#x27;]</span><br><span class="line">  # 组告警等待时间。也就是告警产生后等待10s，如果有同组告警一起发出</span><br><span class="line">  group_wait: 10s</span><br><span class="line">  # 两组告警的间隔时间</span><br><span class="line">  group_interval: 10s</span><br><span class="line">  # 重复告警的间隔时间，减少相同邮件的发送频率</span><br><span class="line">  repeat_interval: 1h</span><br><span class="line">  # 设置默认接收人</span><br><span class="line">  receiver: &#x27;myreceiver&#x27;</span><br><span class="line">  routes:   # 可以指定哪些组接手哪些消息</span><br><span class="line">  - receiver: &#x27;myreceiver&#x27;</span><br><span class="line">    continue: true</span><br><span class="line">    group_wait: 10s</span><br><span class="line">receivers:</span><br><span class="line">- name: &#x27;myreceiver&#x27;</span><br><span class="line">#send_resolved: true</span><br><span class="line">  email_configs:</span><br><span class="line">  # - to: &#x27;example@gmail.com, example2@gmail.com&#x27;</span><br><span class="line">  - to: &#x27;example@gmail.com&#x27;</span><br><span class="line">    html: &#x27;&#123;&#123; template &quot;email.to.html&quot; . &#125;&#125;&#x27;</span><br><span class="line">    headers: &#123; Subject: &quot;Prometheus [Warning] 报警邮件&quot; &#125;</span><br><span class="line">  # 钉钉配置</span><br><span class="line">  webhook_configs:</span><br><span class="line">  - url: &#x27;http://$ip:18080/prometheusalert?type=dd&amp;tpl=prometheus-dd&amp;ddurl=https://oapi.dingtalk.com/robot/send?access_token=xxxxxx&#x27;</span><br></pre></td></tr></table></figure><p>email.tmpl的样例如下，注意样例中有一个”2006-01-02 15:04:05”，这个时间不能改，否则报警显示时间可能会不正确：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; define &quot;email.to.html&quot; &#125;&#125;</span><br><span class="line">&#123;&#123;- if gt (len .Alerts.Firing) 0 -&#125;&#125;</span><br><span class="line">&#123;&#123; range .Alerts &#125;&#125;</span><br><span class="line">=========start==========&lt;br&gt;</span><br><span class="line">告警程序: prometheus_alert &lt;br&gt;</span><br><span class="line">告警级别: &#123;&#123; .Labels.severity &#125;&#125; &lt;br&gt;</span><br><span class="line">告警类型: &#123;&#123; .Labels.alertname &#125;&#125; &lt;br&gt;</span><br><span class="line">告警应用: &#123;&#123; .Labels.app &#125;&#125; &lt;br&gt;</span><br><span class="line">告警主机: &#123;&#123; .Labels.instance &#125;&#125; &lt;br&gt;</span><br><span class="line">告警主题: &#123;&#123; .Annotations.summary &#125;&#125;  &lt;br&gt;</span><br><span class="line">告警详情: &#123;&#123; .Annotations.description &#125;&#125; &lt;br&gt;</span><br><span class="line">触发时间: &#123;&#123; (.StartsAt.Add 28800e9).Format &quot;2006-01-02 15:04:05&quot; &#125;&#125; &lt;br&gt;</span><br><span class="line">=========end==========&lt;br&gt;</span><br><span class="line">&#123;&#123; end &#125;&#125;&#123;&#123; end -&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;- if gt (len .Alerts.Resolved) 0 -&#125;&#125;</span><br><span class="line">&#123;&#123; range .Alerts &#125;&#125;</span><br><span class="line">=========start==========&lt;br&gt;</span><br><span class="line">告警程序: prometheus_alert &lt;br&gt;</span><br><span class="line">告警级别: &#123;&#123; .Labels.severity &#125;&#125; &lt;br&gt;</span><br><span class="line">告警类型: &#123;&#123; .Labels.alertname &#125;&#125; &lt;br&gt;</span><br><span class="line">告警应用: &#123;&#123; .Labels.app &#125;&#125; &lt;br&gt;</span><br><span class="line">告警主机: &#123;&#123; .Labels.instance &#125;&#125; &lt;br&gt;</span><br><span class="line">告警主题: &#123;&#123; .Annotations.summary &#125;&#125; &lt;br&gt;</span><br><span class="line">告警详情: &#123;&#123; .Annotations.description &#125;&#125; &lt;br&gt;</span><br><span class="line">触发时间: &#123;&#123; (.StartsAt.Add 28800e9).Format &quot;2006-01-02 15:04:05&quot; &#125;&#125; &lt;br&gt;</span><br><span class="line">恢复时间: &#123;&#123; (.EndsAt.Add 28800e9).Format &quot;2006-01-02 15:04:05&quot; &#125;&#125; &lt;br&gt;</span><br><span class="line">=========end==========&lt;br&gt;</span><br><span class="line">&#123;&#123; end &#125;&#125;&#123;&#123; end -&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;- end &#125;&#125;</span><br></pre></td></tr></table></figure><p>这两个配置文件，可参考 <a target="_blank" rel="noopener" href="https://prometheus.io/docs/alerting/latest/configuration/">https://prometheus.io/docs/alerting/latest/configuration/</a> 进行修改。</p><h2 id="5-2-启动AlertManager"><a href="#5-2-启动AlertManager" class="headerlink" title="5.2 启动AlertManager"></a>5.2 启动AlertManager</h2><p>运行以下命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 9093:9093 \</span><br><span class="line">  -v /data/docker/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro \</span><br><span class="line">  -v /data/docker/alertmanager/email.tmpl/:/etc/alertmanager/email.tmpl:ro \</span><br><span class="line">  --name alertmanager \</span><br><span class="line">  --restart=always \</span><br><span class="line">  prom/alertmanager:v0.22.2</span><br></pre></td></tr></table></figure><h2 id="5-3-访问"><a href="#5-3-访问" class="headerlink" title="5.3 访问"></a>5.3 访问</h2><p>启动成功后，可通过<code>http://$ip:9093</code>访问alertmanager组件</p><h1 id="六、部署PrometheusAlert"><a href="#六、部署PrometheusAlert" class="headerlink" title="六、部署PrometheusAlert"></a>六、部署PrometheusAlert</h1><p>上节已经提到，Prometheus告警需由两部分组成，上节我们已经部署好AlertManager用于信息处理与通知，本节我们需要定义好Prometheus的配置规则，如此Prometheus便可以产生告警信息并发送到AlertManager。</p><h2 id="6-1-准备工作"><a href="#6-1-准备工作" class="headerlink" title="6.1 准备工作"></a>6.1 准备工作</h2><p>运行以下命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /data/docker/prometheus-alert/conf</span><br><span class="line">sudo chown -R fenixadar:fenixadar /data/docker/prometheus-alert/</span><br><span class="line">nano /data/docker/prometheus-alert/conf/app.conf</span><br></pre></td></tr></table></figure><p>从 <a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/feiyu563/PrometheusAlert/master/conf/app-example.conf">https://raw.githubusercontent.com/feiyu563/PrometheusAlert/master/conf/app-example.conf</a> 下载文件并移动到 &#x2F;data&#x2F;docker&#x2F;prometheus-alert&#x2F;conf&#x2F;app.conf</p><h2 id="6-2-启动"><a href="#6-2-启动" class="headerlink" title="6.2 启动"></a>6.2 启动</h2><p>运行以下命令开启prometheus-alert</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --publish=18080:8080 \</span><br><span class="line">  -v /data/docker/prometheus-alert/conf/:/app/conf:ro \</span><br><span class="line">  -v /data/docker/prometheus-alert/db/:/app/db \</span><br><span class="line">  -v /data/docker/prometheus-alert/log/:/app/logs \</span><br><span class="line">  --name prometheusalert-center \</span><br><span class="line">  feiyu563/prometheus-alert:v-4.5.0</span><br></pre></td></tr></table></figure><p>开启成功后，通过<code>http://$ip:18080</code>，访问prometheus-alert界面。用户密码已在 app.conf 中设置。</p><p>如果系统开启了防火墙，记得开放白名单</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --zone=public --add-port=18080/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure><h2 id="6-3-配置"><a href="#6-3-配置" class="headerlink" title="6.3 配置"></a>6.3 配置</h2><ol><li>配置告警模板</li></ol><p>点击AlertTemplate，进入<code>http://$ip:18080/template</code>，此处有各类可对接的第三方系统的模板。<br>以钉钉的告警模板为例，将模版内容改为如下，主要是修正时间显示慢8小时的问题，以及增加一些信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; $var := .externalURL&#125;&#125;&#123;&#123; range $k,$v:=.alerts &#125;&#125;</span><br><span class="line">&#123;&#123;if eq $v.status &quot;resolved&quot;&#125;&#125;</span><br><span class="line">## [Prometheus恢复信息](&#123;&#123;$v.generatorURL&#125;&#125;)</span><br><span class="line">#### [&#123;&#123;$v.labels.alertname&#125;&#125;](&#123;&#123;$var&#125;&#125;)</span><br><span class="line">###### 告警级别：&#123;&#123;$v.labels.level&#125;&#125;</span><br><span class="line">###### 开始时间：&#123;&#123;GetCSTtime $v.startsAt&#125;&#125;</span><br><span class="line">###### 结束时间：&#123;&#123;GetCSTtime $v.endsAt&#125;&#125;</span><br><span class="line">###### 故障主机名：&#123;&#123;$v.labels.hostname&#125;&#125;</span><br><span class="line">###### 故障主机IP：&#123;&#123;$v.labels.instance&#125;&#125;</span><br><span class="line">###### 故障应用：&#123;&#123;$v.labels.app&#125;&#125;</span><br><span class="line">###### 故障主机对象：&#123;&#123;$v.labels.subject&#125;&#125;</span><br><span class="line">##### &#123;&#123;$v.annotations.description&#125;&#125;</span><br><span class="line">![Prometheus](https://raw.githubusercontent.com/feiyu563/PrometheusAlert/master/doc/alert-center.png)</span><br><span class="line">&#123;&#123;else&#125;&#125;</span><br><span class="line">## [Prometheus告警信息](&#123;&#123;$v.generatorURL&#125;&#125;)</span><br><span class="line">#### [&#123;&#123;$v.labels.alertname&#125;&#125;](&#123;&#123;$var&#125;&#125;)</span><br><span class="line">###### 告警级别：&#123;&#123;$v.labels.level&#125;&#125;</span><br><span class="line">###### 开始时间：&#123;&#123;GetCSTtime $v.startsAt&#125;&#125;</span><br><span class="line">###### 故障主机名：&#123;&#123;$v.labels.hostname&#125;&#125;</span><br><span class="line">###### 故障主机IP：&#123;&#123;$v.labels.instance&#125;&#125;</span><br><span class="line">###### 故障应用：&#123;&#123;$v.labels.app&#125;&#125;</span><br><span class="line">###### 故障主机对象：&#123;&#123;$v.labels.subject&#125;&#125;</span><br><span class="line">##### &#123;&#123;$v.annotations.description&#125;&#125;</span><br><span class="line">![Prometheus](https://raw.githubusercontent.com/feiyu563/PrometheusAlert/master/doc/alert-center.png)</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>设置钉钉机器人<br>在钉钉中，新建一个钉钉群，点击“群设置 -&gt; 智能群助手 -&gt; 添加机器人 -&gt; 自定义 -&gt; 安全设置”，把发送信息的服务器IP地址加进去，而后就会有 Webhook 地址。可参考 <a target="_blank" rel="noopener" href="https://blog.csdn.net/knight_zhou/article/details/105583741">https://blog.csdn.net/knight_zhou/article/details/105583741</a></li></ol><h2 id="6-4-部署-PrometheusAlert-可参考文档"><a href="#6-4-部署-PrometheusAlert-可参考文档" class="headerlink" title="6.4 部署 PrometheusAlert 可参考文档"></a>6.4 部署 PrometheusAlert 可参考文档</h2><p><a target="_blank" rel="noopener" href="https://github.com/feiyu563/PrometheusAlert/blob/master/doc/readme/install.md">https://github.com/feiyu563/PrometheusAlert/blob/master/doc/readme/install.md</a></p><h1 id="七、配置告警规则"><a href="#七、配置告警规则" class="headerlink" title="七、配置告警规则"></a>七、配置告警规则</h1><p>我们还需要在Prometheus Server中配置告警规则，告警规则文件引用配置在prometheus.yml文件的rule_files一节中。规则文件格式是yml，依照2.1小节的配置，在<code>/data/docker/prometheus/alert_rules/</code>文件夹创建yml文件，内容如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br></pre></td><td class="code"><pre><span class="line">groups:</span><br><span class="line">- name: Node_exporter Down</span><br><span class="line">  rules:</span><br><span class="line">  - alert: 实例丢失</span><br><span class="line">    expr: up&#123;job=&quot;node_exporter&quot;&#125; == 0</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      level: Warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;&#123;&#123; $labels.job &#125;&#125;&quot;</span><br><span class="line">      address: &quot;&#123;&#123; $labels.instance &#125;&#125;&quot;</span><br><span class="line">      description: &quot;已经有1分钟连接不上实例了.&quot;</span><br><span class="line">  - alert: CPU使用率过高(&gt; 80)</span><br><span class="line">    expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[2m])) * 100) &gt; 80</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      level: Warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;&#123;&#123; $labels.instance &#125;&#125; CPU使用率过高&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;: CPU使用率超过80%，当前使用率&#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">  - alert: 内存使用率过高(&gt; 80)</span><br><span class="line">    expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes+node_memory_Buffers_bytes+node_memory_Cached_bytes )) / node_memory_MemTotal_bytes * 100 &gt; 80</span><br><span class="line">    for: 1m  #告警持续时间，超过这个时间才会发送给alertmanager</span><br><span class="line">    labels:</span><br><span class="line">      level: Warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;&#123;&#123; $labels.instance &#125;&#125; 内存使用率过高&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;：内存使用率超过80%. 当前使用率&#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">  - alert: 内存压力过大 (&gt; 1000)</span><br><span class="line">    expr: rate(node_vmstat_pgmajfault[1m]) &gt; 1000</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) 内存压力过大&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;：内存压力很大. 当前值&#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">  - alert: 主机网络接口接收了太多的数据 (&gt; 2MB/s)</span><br><span class="line">    expr: sum by (instance) (rate(node_network_receive_bytes_total[2m])) / 1024 / 1024 &gt; 2</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;)主机入向流量异常&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;：持续3分钟网口接收太多数据(&gt; 2MB/s). 当前使用入向流量&#123;&#123; $value &#125;&#125;MB每秒.&quot;</span><br><span class="line">  - alert: 主机网络接口发送了太多的数据 (&gt; 2MB/s)</span><br><span class="line">    expr: sum by (instance) (rate(node_network_transmit_bytes_total[2m])) / 1024 / 1024 &gt; 100</span><br><span class="line">    for: 3m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) 主机出向流量异常&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;：持续3分钟网口发送太多数据(&gt; 2MB/s). 当前使用入向流量&#123;&#123; $value &#125;&#125;MB每秒.&quot;</span><br><span class="line">  - alert: 磁盘每秒读数据（&gt; 50 MB/s）</span><br><span class="line">    expr: sum by (instance) (rate(node_disk_read_bytes_total[2m])) / 1024 / 1024 &gt; 50</span><br><span class="line">    for: 3m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) 主机IO读取异常&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;：主机的IO读取有些问题. 当前值每秒&#123;&#123; $value &#125;&#125;MB&quot;</span><br><span class="line">  - alert: 磁盘每秒写数据（&gt; 50 MB/s）</span><br><span class="line">    expr: sum by (instance) (rate(node_disk_written_bytes_total[2m])) / 1024 / 1024 &gt; 50</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">     summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) 主机IO写入异常&quot;</span><br><span class="line">     description: &quot;&#123;&#123; $labels.instance &#125;&#125;：主机的IO写入有些问题. 当前值每秒&#123;&#123; $value &#125;&#125;MB&quot;</span><br><span class="line">  # Please add ignored mountpoints in node_exporter parameters like</span><br><span class="line">  # &quot;--collector.filesystem.ignored-mount-points=^/(sys|proc|dev|run)($|/)&quot;.</span><br><span class="line">  # Same rule using &quot;node_filesystem_free_bytes&quot; will fire when disk fills for non-root users.</span><br><span class="line">  - alert: 磁盘可用空间（&lt;10% left）</span><br><span class="line">    expr: (node_filesystem_avail_bytes * 100) / node_filesystem_size_bytes &lt; 10 and ON (instance, device, mountpoint) node_filesystem_readonly == 0</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) 主机磁盘告急&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 主机大约还剩10%的磁盘存储. 当前可用剩余&#123;&#123; $value &#125;&#125;%&quot;</span><br><span class="line">  - alert: 磁盘读取延迟大（&gt;100ms）</span><br><span class="line">    expr: rate(node_disk_read_time_seconds_total[1m]) / rate(node_disk_reads_completed_total[1m]) &gt; 0.1 and rate(node_disk_reads_completed_total[1m]) &gt; 0</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) 主机IO读取延迟大&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 主机的IO读取延迟有些大 &gt;100ms . 当前值&#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">  - alert: 磁盘写入延迟大（&gt;100ms）</span><br><span class="line">    expr: rate(node_disk_write_time_seconds_total[1m]) / rate(node_disk_writes_completed_total[1m]) &gt; 0.1 and rate(node_disk_writes_completed_total[1m]) &gt; 0</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) 主机IO写入延迟大&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 主机的IO写入延迟有些大 &gt;100ms . 当前值&#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">  # 1000 context switches is an arbitrary number.</span><br><span class="line">  # Alert threshold depends on nature of application.</span><br><span class="line">  # Please read: https://github.com/samber/awesome-prometheus-alerts/issues/58</span><br><span class="line">  #- alert: 上下文切换的节点越来越多(&gt;1500/s)</span><br><span class="line">  #  expr: (rate(node_context_switches_total[5m])) / (count without(cpu, mode) (node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;)) &gt; 1500</span><br><span class="line">  #  for: 3m</span><br><span class="line">  #  labels:</span><br><span class="line">  #    level: warning</span><br><span class="line">  #  annotations:</span><br><span class="line">  #    summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) 主机上下文节点堆积&quot;</span><br><span class="line">  #    description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 主机上下文节点堆积严重 &gt;1500/s . 当前值&#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">  - alert: 主机 swap 交换分区使用情况 (&gt; 80%)</span><br><span class="line">    expr: (1 - (node_memory_SwapFree_bytes / node_memory_SwapTotal_bytes)) * 100 &gt; 80</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) 主机交换空间警告&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 主机交换内存到达 &gt; 80% . 当前值&#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">  - alert: 主机 systemctl 管理的服务 down</span><br><span class="line">    expr: node_systemd_unit_state&#123;state=&quot;failed&quot;&#125; == 1</span><br><span class="line">    for: 0m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) 有systemctl服务被DOWN&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 的&#123;&#123; $value &#125;&#125;服务被systemctl方式DOWN了&quot;</span><br><span class="line">  - alert: 物理机温度过高( &gt;75°)</span><br><span class="line">    expr: node_hwmon_temp_celsius &gt; 75</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) 主机物理机温度告警&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 主机物理机温度异常( &gt;75°)，当前值&#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">  - alert: 触发物理节点温度报警</span><br><span class="line">    expr: node_hwmon_temp_crit_alarm_celsius == 1</span><br><span class="line">    for: 0m</span><br><span class="line">    labels:</span><br><span class="line">      level: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) 主机主板温度告警&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 主板的温度过高，当前值&#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">  - alert: 主机五分钟内接收到错误包</span><br><span class="line">    expr: rate(node_network_receive_errs_total[2m]) / rate(node_network_receive_packets_total[2m]) &gt; 0.01</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) 主机网络接收到错误包&quot;</span><br><span class="line">      description: &quot;主机  &#123;&#123; $labels.instance &#125;&#125; interface &#123;&#123; $labels.device &#125;&#125; 在过去五分钟内遇到了 &#123;&#123; printf \&quot;%.0f\&quot; $value &#125;&#125; 接收错误&quot;</span><br><span class="line">  - alert: 主机五分钟内发送了错误包</span><br><span class="line">    expr: rate(node_network_transmit_errs_total[2m]) / rate(node_network_transmit_packets_total[2m]) &gt; 0.01</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) 主机网络发送了错误包&quot;</span><br><span class="line">      description: &quot;主机  &#123;&#123; $labels.instance &#125;&#125; interface &#123;&#123; $labels.device &#125;&#125; 在过去五分钟内遇到了 &#123;&#123; printf \&quot;%.0f\&quot; $value &#125;&#125; 接收错误&quot;</span><br><span class="line">  - alert: TCP连接时间过长</span><br><span class="line">    expr: probe_duration_seconds&#123;job=&quot;blackbox_tcp&quot;&#125; &gt; 5</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) TCP连接时间大于5秒&quot;</span><br><span class="line">      description: &quot;TCP连接时间大于5秒, 当前值&#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">  - alert: 主机TCP连接数</span><br><span class="line">    expr: node_netstat_Tcp_CurrEstab &gt; 800</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) TCP连接数过多&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 检测过多TCP连接 &gt; 800, 当前值&#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">  - alert: 待关闭的TCP连接数 &gt; 4000</span><br><span class="line">    expr: node_sockstat_TCP_tw &gt; 4000</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) 等待关闭的TCP连接数 &gt; 4000&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 检测到过多待关闭的TCP连接数, 当前值&#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">  - alert: 检测到时钟偏差</span><br><span class="line">    expr: (node_timex_offset_seconds &gt; 0.05 and deriv(node_timex_offset_seconds[5m]) &gt;= 0) or (node_timex_offset_seconds &lt; -0.05 and deriv(node_timex_offset_seconds[5m]) &lt;= 0)</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) 检测到时钟偏差&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 检测到时钟偏差。时钟不同步, 当前值&#123;&#123; $value &#125;&#125;&quot;</span><br><span class="line">  - alert: 容器停止运行检测</span><br><span class="line">    expr: time() - container_last_seen &gt; 300</span><br><span class="line">    for: 0m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;) 容器可能已经停止运行了&quot;</span><br><span class="line">      description: &quot;容器：&#123;&#123; $labels.name &#125;&#125; - &#123;&#123; $value &#125;&#125;可能已经停止运行了&quot;</span><br><span class="line">  # cAdvisor can sometimes consume a lot of CPU, so this alert will fire constantly.</span><br><span class="line">  # If you want to exclude it from this alert, exclude the serie having an empty name: container_cpu_usage_seconds_total&#123;name!=&quot;&quot;&#125;</span><br><span class="line">  - alert: 容器CPU使用情况</span><br><span class="line">    expr: (sum(rate(container_cpu_usage_seconds_total[3m])) BY (instance, name) * 100) &gt; 300</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;)容器CPU过高&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 容器CPU 使用率 &gt;300% , 当前值&#123;&#123; $value &#125;&#125;%&quot;</span><br><span class="line">  # See https://medium.com/faun/how-much-is-too-much-the-linux-oomkiller-and-used-memory-d32186f29c9d</span><br><span class="line">  #- alert: 容器内存使用情况</span><br><span class="line">  #  expr: (sum(container_memory_working_set_bytes) BY (instance, name) / sum(container_spec_memory_limit_bytes &gt; 0) BY (instance, name) * 100) &gt; 85</span><br><span class="line">  #  for: 2m</span><br><span class="line">  #  labels:</span><br><span class="line">  #    level: warning</span><br><span class="line">  #  annotations:</span><br><span class="line">  #    summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;)容器内存过高&quot;</span><br><span class="line">  #    description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 容器&#123;&#123; $labels.name &#125;&#125;内存 使用率 &gt;85% , 当前值&#123;&#123; $value &#125;&#125;%&quot;</span><br><span class="line">  - alert: 容器卷使用情况</span><br><span class="line">    expr: (1 - (sum(container_fs_inodes_free) BY (instance) / sum(container_fs_inodes_total) BY (instance))) * 100 &gt; 80</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;)容器Volume过高&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 容器&#123;&#123; $labels.name &#125;&#125;,Volume 使用率 &gt;80% , 当前值&#123;&#123; $value &#125;&#125;%&quot;</span><br><span class="line">  - alert: 容器卷IO使用率</span><br><span class="line">    expr: (sum(container_fs_io_current) BY (instance, name) * 100) &gt; 80</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;)容器Volume IO过高&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 容器&#123;&#123; $labels.name &#125;&#125;，Volume IO使用率 &gt;80% , 当前值&#123;&#123; $value &#125;&#125;%&quot;</span><br><span class="line">  - alert: 容器高字节流情况</span><br><span class="line">    expr: rate(container_cpu_cfs_throttled_seconds_total[3m]) &gt; 1</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;)容器字节流过高&quot;</span><br><span class="line">      description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 容器&#123;&#123; $labels.name &#125;&#125;字节流过高&quot;</span><br><span class="line">  - alert: Blackbox探针状态</span><br><span class="line">    expr: probe_success == 0</span><br><span class="line">    for: 5m</span><br><span class="line">    labels:</span><br><span class="line">      level: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;)黑盒检测发现问题&quot;</span><br><span class="line">      description: &quot;任务组&#123;&#123; $labels.job &#125;&#125;采集到问题&quot;</span><br><span class="line">  - alert: Blackbox慢采集</span><br><span class="line">    expr: avg_over_time(probe_duration_seconds[1m]) &gt; 15</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;)黑盒采集过慢&quot;</span><br><span class="line">      description: &quot;Blackbox用了&#123;&#123; $value &#125;&#125;秒多的时间才完成, &#123;&#123; $labels &#125;&#125;&quot;</span><br><span class="line">  - alert: Blackbox Ping时间过长</span><br><span class="line">    expr: probe_duration_seconds&#123;job=&quot;blackbox_ping&quot;&#125; &gt; 5</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;)Blackbox Ping时间过长&quot;</span><br><span class="line">      description: &quot;Ping 时间大于5秒, &#123;&#123; $value &#125;&#125;,&#123;&#123; $labels &#125;&#125;&quot;</span><br><span class="line">  - alert: Blackbox探测Http失败</span><br><span class="line">    expr: probe_http_status_code &lt;= 199 OR probe_http_status_code &gt;= 400</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;(instance &#123;&#123; $labels.instance &#125;&#125;)Blackbox探测Http失败&quot;</span><br><span class="line">      description: &quot;HTTP状态代码不是200-399, &#123;&#123; $value &#125;&#125;,&#123;&#123; $labels &#125;&#125;&quot;</span><br><span class="line">  - alert: SSL 证书 30 天后到期</span><br><span class="line">    expr: probe_ssl_earliest_cert_expiry - time() &lt; 86400 * 30</span><br><span class="line">    for: 60m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: Blackbox SSL证书将很快过期(instance &#123;&#123; $labels.instance &#125;&#125;)</span><br><span class="line">      description: &quot;SSL 证书将在30天后过期，&#123;&#123; $value &#125;&#125;，&#123;&#123; $labels &#125;&#125;&quot;</span><br><span class="line">  - alert: SSL 证书 3 天后到期</span><br><span class="line">    expr: probe_ssl_earliest_cert_expiry - time() &lt; 86400 * 3</span><br><span class="line">    for: 60m</span><br><span class="line">    labels:</span><br><span class="line">      level: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: Blackbox SSL证书将很快过期(instance &#123;&#123; $labels.instance &#125;&#125;)</span><br><span class="line">      description: &quot;SSL 证书将在3天后过期，&#123;&#123; $value &#125;&#125;，&#123;&#123; $labels &#125;&#125;&quot;</span><br><span class="line">  - alert: SSL 证书已经到期</span><br><span class="line">    expr: probe_ssl_earliest_cert_expiry - time() &lt;= 0</span><br><span class="line">    for: 60m</span><br><span class="line">    labels:</span><br><span class="line">      level: critical</span><br><span class="line">    annotations:</span><br><span class="line">      summary: Blackbox SSL证书已经过期(instance &#123;&#123; $labels.instance &#125;&#125;)</span><br><span class="line">      description: &quot;SSL 证书过期了 ，&#123;&#123; $value &#125;&#125;，&#123;&#123; $labels &#125;&#125;&quot;</span><br><span class="line">  - alert: Blackbox采集HTTP过慢</span><br><span class="line">    expr: avg_over_time(probe_http_duration_seconds[1m]) &gt; 3</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Blackbox 探测慢速Http (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;HTTP请求耗时超过3s, 当前值&#123;&#123; $value &#125;&#125;,任务对象&#123;&#123; $labels.instance &#125;&#125;&quot;</span><br><span class="line">  - alert: Blackbox采集ICMP过慢</span><br><span class="line">    expr: avg_over_time(probe_icmp_duration_seconds[1m]) &gt; 3</span><br><span class="line">    for: 2m</span><br><span class="line">    labels:</span><br><span class="line">      level: warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;Blackbox 探测慢速icmp (instance &#123;&#123; $labels.instance &#125;&#125;)&quot;</span><br><span class="line">      description: &quot;ICMP请求耗时超过3s, 当前值&#123;&#123; $value &#125;&#125;,任务对象&#123;&#123; $labels.instance &#125;&#125;&quot;</span><br><span class="line">  - alert: DNS服务器宕机</span><br><span class="line">    expr: probe_dns_answer_rrs == 0</span><br><span class="line">    for: 1m</span><br><span class="line">    labels:</span><br><span class="line">      level: Warning</span><br><span class="line">    annotations:</span><br><span class="line">      summary: &quot;DNS服务器宕机&quot;</span><br><span class="line">      description: &quot;DNS服务器已经有1分钟未响应了，可能已宕机.&quot;</span><br></pre></td></tr></table></figure><p>配置好规则文件后，重启Prometheus Server，可在<code>http://$ip:9090/rules</code>页面查看规则。可以自行搜索下警报状态相关的知识点。</p><p>可参考文档：<a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/">https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/</a></p></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="https://fenixadar.github.io/2022/08/04/%E6%9E%81%E7%AE%80Prometheus%E7%9B%91%E6%8E%A7%E5%AE%9E%E6%88%98/" title="极简Prometheus监控实战" target="_blank" rel="external">https://fenixadar.github.io/2022/08/04/极简Prometheus监控实战/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/fenixadar" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.jpg" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/fenixadar" target="_blank"><span class="text-dark">FenixAdar</span><small class="ml-1x"></small></a></h3><div></div></div></figure></div></div></div></article><section id="comments"><div id="vcomments"></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2022/08/15/%E5%A8%81%E8%81%94%E9%80%9ANAS%20TS-873A%20%E5%AE%9E%E6%B5%8B/" title="威联通NAS TS-873A 实测"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;Newer</span></a></li><li class="next"><a href="/2021/10/28/goframe%E4%B8%8Egin%E5%AF%B9%E6%AF%94(%E5%9B%9B)%20%E6%95%B0%E6%8D%AE%E8%BF%94%E5%9B%9E%E3%80%81Cookie%E3%80%81session%E3%80%81HTTPClient/" title="goframe与gin对比(四) 数据返回、Cookie、session、HTTPClient"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li></ul><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><div class="copyright"><div class="publishby"></div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine"></script><script type="text/javascript">var GUEST=["nick","mail","link"],meta=(meta="nick,mail,link").split(",").filter(function(e){return-1<GUEST.indexOf(e)});new Valine({el:"#vcomments",verify:!1,notify:!1,appId:"4MYosLYygYLCriqKTHXATgkP-gzGzoHsz",appKey:"RANI0qaGuUN6feTLpxeFAf4K",placeholder:"么恭虾米",avatar:"retro",meta:meta,pageSize:"20",visitor:!1})</script></body></html>